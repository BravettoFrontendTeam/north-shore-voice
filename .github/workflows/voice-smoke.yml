name: Voice smoke checks

on: [pull_request]

jobs:
  voice-smoke:
    name: Voice smoke (mocked AbëVoice)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip
          npm ci

      - name: Start AbëVoice mock
        run: |
          python3 scripts/mock/abevoice-mock.py --port 8000 &
          sleep 1

      - name: Run demo fallback smoke
        env:
          ABEVOICE_API_URL: http://127.0.0.1:8000
        run: |
          chmod +x scripts/demo-fallback.sh
          ./scripts/demo-fallback.sh "CI smoke test" "abe"

      - name: Run Abevoice jest test
        working-directory: backend
        run: |
          npm ci
          npm test -- abevoice.emotion.test.ts
