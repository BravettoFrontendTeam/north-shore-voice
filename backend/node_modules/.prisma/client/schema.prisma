// Prisma Schema for North Shore Voice

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Management
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  company   String?
  phone     String?
  plan      Plan     @default(STARTER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  voiceModels     VoiceModel[]
  callSessions    CallSession[]
  trainingSamples TrainingSample[]
  settings        UserSettings?
  apiKeys         ApiKey[]

  @@map("users")
}

model UserSettings {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Notification settings
  emailNotifications Boolean @default(true)
  smsNotifications   Boolean @default(false)
  callSummaries      Boolean @default(true)
  weeklyReports      Boolean @default(true)
  marketingEmails    Boolean @default(false)

  // Business context
  companyName     String?
  industry        String?
  greeting        String?
  fallbackMessage String?
  businessHours   Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_settings")
}

model ApiKey {
  id        String     @id @default(uuid())
  userId    String
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  key       String     @unique
  name      String
  type      ApiKeyType @default(PRODUCTION)
  lastUsed  DateTime?
  expiresAt DateTime?
  createdAt DateTime   @default(now())

  @@map("api_keys")
}

// Voice Models
model VoiceModel {
  id     String           @id @default(uuid())
  userId String
  user   User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  name   String
  status VoiceModelStatus @default(PENDING)

  // Personality settings
  friendliness    Int @default(70)
  professionalism Int @default(80)
  energy          Int @default(60)
  formality       Int @default(60)

  // AbÃ«Voice integration
  externalVoiceId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  samples      TrainingSample[]
  callSessions CallSession[]

  @@map("voice_models")
}

model TrainingSample {
  id           String      @id @default(uuid())
  userId       String
  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  voiceModelId String?
  voiceModel   VoiceModel? @relation(fields: [voiceModelId], references: [id], onDelete: SetNull)

  filename     String
  originalName String
  fileSize     Int
  duration     Float?
  mimeType     String

  createdAt DateTime @default(now())

  @@map("training_samples")
}

// Call Management
model CallSession {
  id           String      @id @default(uuid())
  userId       String
  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  voiceModelId String?
  voiceModel   VoiceModel? @relation(fields: [voiceModelId], references: [id], onDelete: SetNull)

  phoneNumber String
  direction   CallDirection @default(INBOUND)
  status      CallStatus    @default(PENDING)

  startTime DateTime  @default(now())
  endTime   DateTime?
  duration  Int?

  // Analysis
  sentiment Sentiment?
  topics    String[]

  // External references
  externalCallId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  transcript TranscriptMessage[]
  summary    CallSummary?

  @@index([userId, createdAt])
  @@index([status])
  @@map("call_sessions")
}

model TranscriptMessage {
  id            String      @id @default(uuid())
  callSessionId String
  callSession   CallSession @relation(fields: [callSessionId], references: [id], onDelete: Cascade)

  speaker    Speaker
  text       String
  confidence Float?
  timestamp  DateTime @default(now())

  @@index([callSessionId, timestamp])
  @@map("transcript_messages")
}

model CallSummary {
  id            String      @id @default(uuid())
  callSessionId String      @unique
  callSession   CallSession @relation(fields: [callSessionId], references: [id], onDelete: Cascade)

  summary     String
  actionItems String[]
  keyPoints   String[]

  createdAt DateTime @default(now())

  @@map("call_summaries")
}

// Analytics
model DailyAnalytics {
  id     String   @id @default(uuid())
  userId String
  date   DateTime @db.Date

  totalCalls     Int   @default(0)
  completedCalls Int   @default(0)
  missedCalls    Int   @default(0)
  totalDuration  Int   @default(0)
  avgDuration    Float @default(0)

  positiveSentiment Int @default(0)
  neutralSentiment  Int @default(0)
  negativeSentiment Int @default(0)

  topTopics Json?
  peakHours Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, date])
  @@map("daily_analytics")
}

// Enums
enum Plan {
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum VoiceModelStatus {
  PENDING
  TRAINING
  READY
  FAILED
}

enum CallDirection {
  INBOUND
  OUTBOUND
}

enum CallStatus {
  PENDING
  ACTIVE
  COMPLETED
  MISSED
  FAILED
}

enum Speaker {
  AI
  CALLER
}

enum Sentiment {
  POSITIVE
  NEUTRAL
  NEGATIVE
}

enum ApiKeyType {
  PRODUCTION
  DEVELOPMENT
}
