// Prisma Schema for North Shore Voice

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "darwin", "darwin-arm64"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // P0 Fix 4: Use connection pooling (Vercel Postgres includes PgBouncer)
  // Serverless: 1 connection per function instance
}

// User Management
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  company   String?
  phone     String?
  plan      Plan     @default(STARTER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  voiceModels     VoiceModel[]
  callSessions    CallSession[]
  trainingSamples TrainingSample[]
  settings        UserSettings?
  apiKeys         ApiKey[]

  @@map("users")
}

model UserSettings {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Notification settings
  emailNotifications Boolean @default(true)
  smsNotifications   Boolean @default(false)
  callSummaries      Boolean @default(true)
  weeklyReports      Boolean @default(true)
  marketingEmails    Boolean @default(false)

  // Business context
  companyName     String?
  industry        String?
  greeting        String?
  fallbackMessage String?
  businessHours   Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_settings")
}

model ApiKey {
  id        String     @id @default(uuid())
  userId    String
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  key       String     @unique
  name      String
  type      ApiKeyType @default(PRODUCTION)
  lastUsed  DateTime?
  expiresAt DateTime?
  createdAt DateTime   @default(now())

  @@map("api_keys")
}

// Voice Models
model VoiceModel {
  id     String           @id @default(uuid())
  userId String
  user   User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  name   String
  status VoiceModelStatus @default(PENDING)

  // Personality settings
  friendliness    Int @default(70)
  professionalism Int @default(80)
  energy          Int @default(60)
  formality       Int @default(60)

  // AbÃ«Voice integration
  externalVoiceId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  samples      TrainingSample[]
  callSessions CallSession[]

  @@map("voice_models")
}

model TrainingSample {
  id           String      @id @default(uuid())
  userId       String
  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  voiceModelId String?
  voiceModel   VoiceModel? @relation(fields: [voiceModelId], references: [id], onDelete: SetNull)

  filename     String
  originalName String
  fileSize     Int
  duration     Float?
  mimeType     String

  createdAt DateTime @default(now())

  @@map("training_samples")
}

// Call Management
model CallSession {
  id           String      @id @default(uuid())
  userId       String
  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  voiceModelId String?
  voiceModel   VoiceModel? @relation(fields: [voiceModelId], references: [id], onDelete: SetNull)

  phoneNumber String
  direction   CallDirection @default(INBOUND)
  status      CallStatus    @default(PENDING)

  startTime DateTime  @default(now())
  endTime   DateTime?
  duration  Int?

  // Analysis
  sentiment Sentiment?
  topics    String[]

  // External references
  externalCallId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  transcript TranscriptMessage[]
  summary    CallSummary?

  @@index([userId, createdAt])
  @@index([status])
  @@map("call_sessions")
}

model TranscriptMessage {
  id            String      @id @default(uuid())
  callSessionId String
  callSession   CallSession @relation(fields: [callSessionId], references: [id], onDelete: Cascade)

  speaker    Speaker
  text       String
  confidence Float?
  timestamp  DateTime @default(now())

  @@index([callSessionId, timestamp])
  @@map("transcript_messages")
}

model CallSummary {
  id            String      @id @default(uuid())
  callSessionId String      @unique
  callSession   CallSession @relation(fields: [callSessionId], references: [id], onDelete: Cascade)

  summary     String
  actionItems String[]
  keyPoints   String[]

  createdAt DateTime @default(now())

  @@map("call_summaries")
}

// Analytics
model DailyAnalytics {
  id     String   @id @default(uuid())
  userId String
  date   DateTime @db.Date

  totalCalls     Int   @default(0)
  completedCalls Int   @default(0)
  missedCalls    Int   @default(0)
  totalDuration  Int   @default(0)
  avgDuration    Float @default(0)

  positiveSentiment Int @default(0)
  neutralSentiment  Int @default(0)
  negativeSentiment Int @default(0)

  topTopics Json?
  peakHours Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, date])
  @@map("daily_analytics")
}

// Business Configuration for Inbound/Outbound
model Business {
  id       String  @id @default(uuid())
  userId   String
  name     String
  phone    String?
  timezone String  @default("America/New_York")

  // Inbound Configuration
  inboundConfig  Json? // InboundConfig type
  outboundConfig Json? // OutboundConfig type

  // Voice Settings
  defaultVoiceId  String?
  greeting        String?
  voicemailPrompt String?
  holdMusicUrl    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  inboundCalls  InboundCall[]
  outboundCalls OutboundCall[]
  routingRules  CallRoutingRule[]
  campaigns     OutboundCampaign[]
  callQueue     CallQueue[]

  @@map("businesses")
}

// Inbound Calls
model InboundCall {
  id         String   @id @default(uuid())
  businessId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  callerNumber String
  callerName   String?

  // Call Details
  status   InboundCallStatus @default(RINGING)
  duration Int?
  waitTime Int? // Queue wait time in seconds

  // Routing
  routedTo      String? // ai_agent, voicemail, transfer, agent_id
  routingRuleId String?

  // Content
  transcript String?
  summary    String?
  sentiment  Sentiment?
  tags       String[]

  // External
  externalCallId String?
  recordingUrl   String?

  startedAt  DateTime  @default(now())
  answeredAt DateTime?
  endedAt    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId, createdAt])
  @@index([status])
  @@index([callerNumber])
  @@map("inbound_calls")
}

// Outbound Calls
model OutboundCall {
  id         String   @id @default(uuid())
  businessId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  recipientNumber String
  recipientName   String?

  // Campaign Reference
  campaignId String?
  campaign   OutboundCampaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)

  // Call Details
  status OutboundCallStatus @default(PENDING)
  result CallResult?

  duration    Int?
  attempts    Int  @default(0)
  maxAttempts Int  @default(3)

  // Content
  scriptUsed String?
  transcript String?
  notes      String?

  // Scheduling
  scheduledAt DateTime?
  startedAt   DateTime?
  completedAt DateTime?

  // External
  externalCallId String?
  recordingUrl   String?

  // Callback handling
  isCallback     Boolean @default(false)
  callbackReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId, createdAt])
  @@index([campaignId])
  @@index([status])
  @@index([scheduledAt])
  @@map("outbound_calls")
}

// Call Routing Rules
model CallRoutingRule {
  id         String   @id @default(uuid())
  businessId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  name     String
  priority Int     @default(0)
  isActive Boolean @default(true)

  // Condition
  conditionType  ConditionType
  conditionValue Json // Depends on type

  // Action
  actionType   ActionType
  actionConfig Json // Depends on type

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId, isActive])
  @@map("call_routing_rules")
}

// Outbound Campaigns
model OutboundCampaign {
  id         String   @id @default(uuid())
  businessId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  name        String
  description String?

  // Script
  scriptTemplate String
  voiceId        String?

  // Contact List
  contactList   Json // Array of Contact objects
  totalContacts Int  @default(0)

  // Schedule
  scheduleConfig Json? // CallSchedule type
  startDate      DateTime?
  endDate        DateTime?

  // Rate Limiting
  callsPerMinute Int @default(5)
  maxConcurrent  Int @default(3)

  // Status & Progress
  status         CampaignStatus @default(DRAFT)
  completedCalls Int            @default(0)
  answeredCalls  Int            @default(0)
  voicemailCalls Int            @default(0)
  failedCalls    Int            @default(0)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  startedAt   DateTime?
  completedAt DateTime?

  // Relations
  calls OutboundCall[]

  @@index([businessId, status])
  @@map("outbound_campaigns")
}

// Call Queue for managing live calls
model CallQueue {
  id         String   @id @default(uuid())
  businessId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  callerNumber String
  callerName   String?

  status   QueueStatus @default(WAITING)
  position Int
  priority Int         @default(0)

  estimatedWait Int? // Seconds
  actualWait    Int? // Seconds

  externalCallId String?

  enteredAt DateTime  @default(now())
  servedAt  DateTime?

  @@index([businessId, status])
  @@index([position])
  @@map("call_queue")
}

// Callback Requests
model CallbackRequest {
  id         String @id @default(uuid())
  businessId String

  phoneNumber   String
  name          String?
  reason        String?
  preferredTime DateTime?

  status CallbackStatus @default(PENDING)

  // Reference to resulting outbound call
  outboundCallId String?

  requestedAt DateTime  @default(now())
  processedAt DateTime?

  @@index([businessId, status])
  @@map("callback_requests")
}

// Enums
enum Plan {
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum VoiceModelStatus {
  PENDING
  TRAINING
  READY
  FAILED
}

enum CallDirection {
  INBOUND
  OUTBOUND
}

enum CallStatus {
  PENDING
  ACTIVE
  COMPLETED
  MISSED
  FAILED
}

enum Speaker {
  AI
  CALLER
}

enum Sentiment {
  POSITIVE
  NEUTRAL
  NEGATIVE
}

enum ApiKeyType {
  PRODUCTION
  DEVELOPMENT
}

// Inbound/Outbound Call Enums
enum InboundCallStatus {
  RINGING
  QUEUED
  IN_PROGRESS
  ON_HOLD
  TRANSFERRED
  COMPLETED
  MISSED
  VOICEMAIL
  FAILED
}

enum OutboundCallStatus {
  PENDING
  SCHEDULED
  DIALING
  IN_PROGRESS
  COMPLETED
  FAILED
  CANCELLED
}

enum CallResult {
  ANSWERED
  VOICEMAIL
  BUSY
  NO_ANSWER
  FAILED
  CANCELLED
  CALLBACK_REQUESTED
}

enum ConditionType {
  TIME_BASED // Business hours, after hours
  CALLER_ID // Specific numbers or patterns
  KEYWORD // Keywords in conversation
  QUEUE_LENGTH // Queue overflow
  CALLER_HISTORY // Repeat callers
}

enum ActionType {
  AI_AGENT // Route to AI
  VOICEMAIL // Send to voicemail
  TRANSFER // Transfer to number/agent
  PLAY_MESSAGE // Play recorded message
  QUEUE // Add to queue
  CALLBACK // Schedule callback
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  RUNNING
  PAUSED
  COMPLETED
  CANCELLED
}

enum QueueStatus {
  WAITING
  BEING_SERVED
  SERVED
  ABANDONED
  TRANSFERRED
}

enum CallbackStatus {
  PENDING
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  FAILED
  CANCELLED
}
